## Requirements Recap
- Support multi-provider integrations (Apple Health, Garmin, Whoop, Oura, Strava) with raw payload retention.
- Support multi-discipline training + hobbies, both planned and unplanned.
- Support manual logging across all disciplines.
- Support goal hierarchies (12-week + 12-month), goals can change, system adapts.
- Support user demographics/biometrics history (age/DOB, sex, height/weight trends).
- Support per-domain skills/capabilities and movement scaling/regressions.
- Support fatigue inference across lifting + cardio + hobbies.

## Core Design Principles
- Separate **Definitions** (what an activity/movement is) from **Instances** (a performed/planned event).
- Use relational tables for high-selectivity analytics (fatigue, adherence, trends); use JSON only for raw ingestion and rarely-queried, high-variance payloads.
- Treat integrations as an ingestion pipeline with a staging “data lake” plus a canonical normalized layer.
- Ensure every adaptive recommendation has traceable provenance: goal version + heuristics config version + ingestion run id.

## Proposed Schema Evolution (High-Level)
### 1) Integrations & Raw Data Lake
Add:
- `external_provider_accounts` (user ↔ provider OAuth/account)
  - `id`, `user_id`, `provider` (enum), `external_user_id`, `scopes`, `access_token_encrypted`, `refresh_token_encrypted`, `token_expires_at`, `status`, `created_at`, `updated_at`
- `external_ingestion_runs`
  - `id`, `user_id`, `provider`, `started_at`, `finished_at`, `status`, `error`, `cursor_json`
- `external_activity_records` (staging)
  - `id`, `user_id`, `provider`, `external_id`, `activity_type_raw`, `start_time`, `end_time`, `timezone`, `raw_payload_json`, `ingestion_run_id`, `created_at`
- `external_metric_streams` (optional; time series)
  - `id`, `external_activity_record_id`, `stream_type` (hr/pace/power/cadence/etc), `raw_stream_json` or `samples` table

### 2) Canonical “Activity” Model (Planned + Performed)
Introduce a unified activity log model that can represent:
- training sessions generated by the program
- workouts completed (manual or imported)
- hobbies (tennis/hiking/swimming)

Add:
- `activity_definitions` (taxonomy)
  - `id`, `name`, `category` (enum: strength/cardio/mobility/sport/etc), `discipline_id`, `default_metric_type`, `default_equipment_tags`
- `activity_instances` (the canonical event)
  - `id`, `user_id`, `planned_session_id` (nullable), `source` (enum: planned/manual/provider), `activity_definition_id` (nullable), `performed_start`, `performed_end`, `duration_seconds`, `notes`, `perceived_difficulty`, `enjoyment_rating`, `visibility`, `created_at`
- `activity_instance_links`
  - `activity_instance_id`, `external_activity_record_id` (nullable), `workout_log_id` (nullable) to bridge legacy tables during migration

Modify (long-term):
- Gradually make `workout_logs` a specialization or migrate it into `activity_instances`.

### 3) Disciplines & Tag Normalization
Add:
- `disciplines`
  - `id`, `slug`, `name` (crossfit/hyrox/powerlifting/etc)
- `user_discipline_preferences`
  - `user_id`, `discipline_id`, `weight`, `enabled`, `notes`

Migrate/replace:
- `programs.disciplines_json` → normalized join table `program_disciplines`.

### 4) Goals: Macro + Micro + Versioning
Add:
- `macro_cycles`
  - `id`, `user_id`, `start_date`, `end_date`, `name`, `created_at`
- `goals` (versioned)
  - `id`, `user_id`, `macro_cycle_id` (nullable), `program_id` (nullable), `goal_type` (enum), `target_json`, `priority`, `status`, `effective_from`, `effective_to`, `created_at`
- `goal_checkins`
  - `id`, `goal_id`, `date`, `value_json`, `notes`

Modify:
- Keep `programs.goal_1/2/3` as an MVP snapshot, but treat it as derived from `goals` for future-proofing.

### 5) User Profile & Biometrics History
Add:
- `user_profile`
  - `user_id` (PK/FK), `date_of_birth`, `sex` (enum), `height_cm`, `created_at`, `updated_at`
- `user_biometrics_history`
  - `id`, `user_id`, `date`, `metric_type` (enum: weight_kg/body_fat/resting_hr/etc), `value`, `source` (manual/provider), `external_record_id` (nullable)

### 6) Skill Matrix, Capabilities, and Scaling
Add:
- `user_skill_profiles`
  - `id`, `user_id`, `scope_type` (enum: discipline/pattern/movement), `scope_id` (FK to discipline or movement; pattern can be enum), `skill_level` (enum), `can_do_flag`, `notes`, `updated_at`
- `movement_progressions` (directional graph; replaces/realizes MovementRelationship)
  - `id`, `source_movement_id`, `target_movement_id`, `relationship_type` (enum progression/regression/variation), `difficulty_delta`, `notes`

Fix/migrate:
- Add Alembic migration for existing ORM model `movement_relationships` (currently model exists but no migration).

### 7) Fatigue / Anatomy / Load Modeling
Add:
- `muscles` (or reuse enum values as rows)
  - `id`, `name`, `region`
- `movement_muscle_map`
  - `movement_id`, `muscle_id`, `role` (enum primary/secondary/stabilizer), `magnitude` (0–1)
- `activity_muscle_map`
  - `activity_definition_id`, `muscle_id`, `magnitude`, `cns_impact`
- `user_fatigue_state` (optional cached)
  - `user_id`, `date`, `muscle_id`, `fatigue_score`, `computed_from` (run id), `created_at`

## Immediate Gaps to Resolve Before Expanding
- Align DB vs API schema mismatches:
  - `RecoverySignalCreate.raw_payload` exists in schema/routes but no DB column; either add `raw_payload_json` to `recovery_signals` or remove from schema.
  - Settings schemas/endpoints reference fields not present in `user_settings` table; decide canonical settings surface and migrate accordingly.
  - `AdaptationService._is_movement_forbidden` checks `"forbidden"` but enum uses `hard_no`.
- Provider naming cleanup: `AURA_RING` string likely should be `"oura"` (or `"oura_ring"`) and standardized.

## Migration / Delivery Plan (Incremental)
1) Produce a single authoritative data dictionary (tables + enums + categorical queries) and confirm “source of truth” for sessions vs session_exercises vs JSON sections.
2) Add missing migrations + fix schema mismatches (movement_relationships, recovery raw payload, user_settings fields).
3) Introduce foundational new tables: `user_profile`, `user_biometrics_history`, `macro_cycles`, `goals` (versioned).
4) Introduce integrations scaffolding: `external_provider_accounts`, `external_ingestion_runs`, `external_activity_records`.
5) Introduce canonical `activity_definitions` + `activity_instances`, and wire manual logger to create `activity_instances`.
6) Add fatigue/anatomy normalization (`movement_muscle_map` etc.) and start computing weekly muscle load across *both* planned and performed activities.
7) Gradually migrate legacy tables (`workout_logs`, program goals) to become derived views or linked artifacts.

## Verification Strategy
- Add migration tests (upgrade/downgrade) + simple smoke queries.
- Add seed fixtures for at least one provider activity + one manual activity + one planned session; verify linking and analytics queries.
- Add “distinct categorical values” extraction queries for all open categorical fields.

If you confirm this plan, I will implement it in the repo incrementally starting from the mismatch fixes and the first set of new tables/migrations.